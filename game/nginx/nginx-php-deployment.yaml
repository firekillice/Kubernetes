apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-php
spec:
  selector: # 尝试选择已经存在在系统中的pod
    matchLabels:
      app: nginx-php
  replicas: 1
  template:
    metadata:
      labels:
        app: nginx-php
    spec:
      serviceAccountName: aliyun
      imagePullSecrets:
        - name: aliyun-secret
      containers:
      # nginx 启动game的container
      - name: nginx-game
        image: nginx:latest
        command: [ "/bin/bash", "-ce", "tail -f /dev/null" ]
        ports:
        - containerPort: 80
        volumeMounts:
        - mountPath: /etc/localtime
          name: time
          readOnly: true
        
        - name: nginx-nginx-conf
          mountPath: /etc/nginx/nginx.conf
          subPath: nginx.conf
          readOnly: true
        - name: nginx-server-conf
          mountPath: /etc/nginx/server.conf
          subPath: server.conf
          readOnly: true
        - name: nginx-fcgi-conf
          mountPath: /etc/nginx/fcgi.conf
          subPath: fcgi.conf
          readOnly: true
        - name: nginx-conf-d-upstream-php-conf
          mountPath: /etc/nginx/conf.d/upstream_php-fpm.conf
          subPath: upstream_php-fpm.conf
          readOnly: true
        - name: nginx-conf-d-game-conf
          mountPath: /etc/nginx/conf.d/game.conf
          subPath: game.conf
          readOnly: true
        - mountPath: /logs
          name: log-normal-path

      # nginx中启动manager的container
      - name: nginx-manage
        image: nginx:latest
        command: [ "/bin/bash", "-ce", "tail -f /dev/null" ]
        ports:
        - containerPort: 81
        volumeMounts:
        - mountPath: /etc/localtime
          name: time
          readOnly: true
        
        - name: nginx-nginx-conf
          mountPath: /etc/nginx/nginx.conf
          subPath: nginx.conf
          readOnly: true
        - name: nginx-server-conf
          mountPath: /etc/nginx/server.conf
          subPath: server.conf
          readOnly: true
        - name: nginx-fcgi-conf
          mountPath: /etc/nginx/fcgi.conf
          subPath: fcgi.conf
          readOnly: true
        - name: nginx-conf-d-upstream-php-conf
          mountPath: /etc/nginx/conf.d/upstream_php-fpm.conf
          subPath: upstream_php-fpm.conf
          readOnly: true
        - name: nginx-conf-d-manage-conf
          mountPath: /etc/nginx/conf.d/manage.conf
          subPath: manage.conf
          readOnly: true
        - mountPath: /logs
          name: log-normal-path

      # nginx中启动rockmong的container
      - name: nginx-rock-mongo
        image: nginx:latest
        command: [ "/bin/bash", "-ce", "tail -f /dev/null" ]
        ports:
        - containerPort: 82
        volumeMounts:
        - mountPath: /etc/localtime
          name: time
          readOnly: true
        
        - name: nginx-nginx-conf
          mountPath: /etc/nginx/nginx.conf
          subPath: nginx.conf
          readOnly: true
        - name: nginx-server-conf
          mountPath: /etc/nginx/server.conf
          subPath: server.conf
          readOnly: true
        - name: nginx-fcgi-conf
          mountPath: /etc/nginx/fcgi.conf
          subPath: fcgi.conf
          readOnly: true
        - name: nginx-conf-d-upstream-php-conf
          mountPath: /etc/nginx/conf.d/upstream_php-fpm.conf
          subPath: upstream_php-fpm.conf
          readOnly: true
        - name: nginx-conf-d-rock-mongo-conf
          mountPath: /etc/nginx/conf.d/rock-mongo.conf
          subPath: rock-mongo.conf
          readOnly: true
        - mountPath: /logs
          name: log-normal-path

      # PHP的container
      - name: php-fpm-server
        image: registry.cn-hangzhou.aliyuncs.com/sandstone/php:v-game-1.0.0
        #imagePullPolicy: Always
        imagePullPolicy: IfNotPresent
        command: [ "/bin/bash", "-ce", "tail -f /dev/null" ]
        ports:
        - containerPort: 9000
        volumeMounts:
        - mountPath: /etc/localtime
          name: time
          readOnly: true
        - mountPath: /code/game
          name: php-game-code-path
        - mountPath: /code/rock
          name: php-rock-mongo-code-path
        - mountPath: /code/manage
          name: php-manage-code-path
        - mountPath: /logs
          name: log-normal-path
          
      volumes:
      - name: time
        hostPath:
          path: /etc/localtime
      - name: nginx-server-conf
        configMap:
          name: nginx-server-conf
      - name: nginx-nginx-conf
        configMap:
          name: nginx-nginx-conf
      - name: nginx-fcgi-conf
        configMap:
          name: nginx-fcgi-conf
      - name: nginx-conf-d-upstream-php-conf
        configMap:
          name: nginx-conf-d-upstream-php-conf
      - name: nginx-conf-d-game-conf
        configMap:
          name: nginx-conf-d-game-conf
      - name: nginx-conf-d-manage-conf
        configMap:
          name: nginx-conf-d-manage-conf
      - name: nginx-conf-d-rock-mongo-conf
        configMap:
          name: nginx-conf-d-rock-mongo-conf
      - name: php-rock-mongo-code-path
        hostPath:
          path: /data/cuser00/wwww/igoal3_server/rockmongo-master
      - name: php-game-code-path
        hostPath:
          path:  /data/cuser00/wwww/igoal3_server/gameserver
      - name: php-manage-code-path
        hostPath:
          path: /data/cuser00/wwww/igoal3_server/manage
      - name: log-normal-path
        hostPath:
          path: /data/cuser00/var/log
